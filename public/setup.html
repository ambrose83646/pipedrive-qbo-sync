<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickBooks Setup - OnitQb</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }
    
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 40px;
    }
    
    .qb-logo {
      width: 50px;
      height: 50px;
      background: #2ca01c;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 24px;
      margin-right: 20px;
    }
    
    .header-text h1 {
      font-size: 24px;
      color: #333;
      margin-bottom: 4px;
    }
    
    .header-text p {
      color: #666;
      font-size: 14px;
    }
    
    .step-indicator {
      display: flex;
      margin-bottom: 40px;
      position: relative;
    }
    
    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }
    
    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #666;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
      font-size: 14px;
      position: relative;
      z-index: 2;
    }
    
    .step.active .step-number {
      background: #2ca01c;
      color: white;
    }
    
    .step.completed .step-number {
      background: #2ca01c;
      color: white;
    }
    
    .step-title {
      font-size: 14px;
      color: #666;
    }
    
    .step.active .step-title {
      color: #333;
      font-weight: 500;
    }
    
    .step-connector {
      position: absolute;
      top: 15px;
      left: 50%;
      width: calc(100% - 30px);
      height: 2px;
      background: #e0e0e0;
      z-index: 1;
    }
    
    .step.completed .step-connector {
      background: #2ca01c;
    }
    
    .step-content {
      display: none;
    }
    
    .step-content.active {
      display: block;
    }
    
    h2 {
      font-size: 20px;
      color: #333;
      margin-bottom: 20px;
    }
    
    .checkbox-group {
      margin: 30px 0;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: flex-start;
    }
    
    input[type="checkbox"] {
      margin-right: 12px;
      margin-top: 2px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .checkbox-label {
      flex: 1;
      font-size: 15px;
      line-height: 1.5;
      color: #333;
      cursor: pointer;
    }
    
    .warning-box {
      background: #fff9e6;
      border: 1px solid #ffd666;
      border-radius: 6px;
      padding: 16px;
      margin: 20px 0;
      display: flex;
      align-items: flex-start;
    }
    
    .warning-icon {
      color: #faad14;
      margin-right: 12px;
      font-size: 20px;
    }
    
    .warning-text {
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
      color: #595959;
    }
    
    .form-section {
      margin: 30px 0;
    }
    
    .form-section h3 {
      font-size: 16px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .form-label {
      width: 180px;
      font-size: 14px;
      color: #595959;
      display: flex;
      align-items: center;
    }
    
    .form-control {
      flex: 1;
      position: relative;
    }
    
    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
      background: white;
      transition: border-color 0.3s;
    }
    
    select:focus, input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: #40a9ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    
    .field-selector {
      position: relative;
      width: 100%;
    }
    
    .field-selector select {
      appearance: none;
      padding-right: 30px;
    }
    
    .field-selector::after {
      content: '▼';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #666;
      font-size: 12px;
    }
    
    .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #e6f7ff;
      color: #1890ff;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      margin-left: 8px;
      cursor: help;
    }
    
    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    
    .btn {
      padding: 10px 24px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }
    
    .btn-secondary {
      background: white;
      color: #333;
      border-color: #d9d9d9;
    }
    
    .btn-secondary:hover {
      border-color: #40a9ff;
      color: #40a9ff;
    }
    
    .btn-primary {
      background: #2ca01c;
      color: white;
    }
    
    .btn-primary:hover {
      background: #239018;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }
    
    .loading.active {
      display: block;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2ca01c;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .success-message {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }
    
    .success-message.active {
      display: block;
    }
    
    .success-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #52c41a;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 30px;
    }
    
    .date-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .date-input-group input {
      width: 80px;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="qb-logo">qb</div>
      <div class="header-text">
        <h1>QuickBooks</h1>
        <p>Accounting & invoicing</p>
        <p style="margin-top: 4px; font-weight: 500;">Pipedrive</p>
      </div>
    </div>
    
    <div class="step-indicator">
      <div class="step active" id="step1-indicator">
        <span class="step-number">1</span>
        <div class="step-connector"></div>
        <div class="step-title">User Authorization</div>
      </div>
      <div class="step" id="step2-indicator">
        <span class="step-number">2</span>
        <div class="step-title">Invoice Preferences</div>
      </div>
    </div>
    
    <!-- Step 1: User Authorization -->
    <div class="step-content active" id="step1">
      <h2>User Authorization</h2>
      
      <div class="checkbox-group">
        <div class="checkbox-wrapper">
          <input type="checkbox" id="authorizeUsers" name="authorizeUsers">
          <label for="authorizeUsers" class="checkbox-label">
            Allow other users in my organization to view, edit and create new invoices using this app.
          </label>
        </div>
      </div>
      
      <div class="warning-box">
        <span class="warning-icon">⚠️</span>
        <div class="warning-text">
          By enabling QuickBooks integration for all users, you authorize them to access, issue and manage invoices on behalf of your company. Please note that any actions taken by users through this integration will appear as actions taken by you, the admin.
          <br><br>
          Review permissions carefully before enabling. User access can be changed at any time via <strong>Tools and Apps > Invoicing</strong>
        </div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-secondary" onclick="skipAuthorization()">Skip</button>
        <button class="btn btn-primary" onclick="saveAuthorization()">Continue</button>
      </div>
    </div>
    
    <!-- Step 2: Invoice Preferences -->
    <div class="step-content" id="step2">
      <h2>Invoicing preferences</h2>
      <p style="color: #666; margin-bottom: 20px;">
        The fields below refer to the Customer and Invoice Details you can send when creating an invoice.<br>
        By choosing a field from the list, you will be setting the values to populate the invoice form so you don't have to do it manually every time.
      </p>
      
      <div class="form-section">
        <h3>General preferences</h3>
        
        <div class="form-row">
          <label class="form-label">Contact</label>
          <div class="form-control">
            <div class="field-selector">
              <select id="contactField">
                <option value="">Choose a field</option>
                <option value="name" selected>Name</option>
                <option value="org_name">Organization Name</option>
                <option value="first_name">First Name</option>
                <option value="last_name">Last Name</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <label class="form-label">Address</label>
          <div class="form-control">
            <div class="field-selector">
              <select id="addressField">
                <option value="">Choose a field</option>
                <option value="address" selected>Address</option>
                <option value="billing_address">Billing Address</option>
                <option value="shipping_address">Shipping Address</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <label class="form-label">Email</label>
          <div class="form-control">
            <div class="field-selector">
              <select id="emailField">
                <option value="">Choose a field</option>
                <option value="email" selected>Email</option>
                <option value="primary_email">Primary Email</option>
                <option value="billing_email">Billing Email</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <label class="form-label">
            Customer tax ID
            <span class="tooltip">
              <span class="info-icon">?</span>
              <span class="tooltiptext">Customer's tax identification number for invoice records</span>
            </span>
          </label>
          <div class="form-control">
            <div class="field-selector">
              <select id="taxIdField">
                <option value="">No options found</option>
                <option value="tax_id">Tax ID</option>
                <option value="vat_number">VAT Number</option>
                <option value="ein">EIN</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <label class="form-label">Due date</label>
          <div class="form-control">
            <div class="date-input-group">
              <input type="number" id="dueDateDays" min="0" max="365" value="30">
              <select id="dueDateType">
                <option value="days">Days from invoice date</option>
                <option value="net30">Net 30</option>
                <option value="net60">Net 60</option>
                <option value="net90">Net 90</option>
                <option value="immediate">Due on receipt</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <label class="form-label">
            Default tax rate
            <span class="tooltip">
              <span class="info-icon">?</span>
              <span class="tooltiptext">Default tax rate to apply to invoice items</span>
            </span>
          </label>
          <div class="form-control">
            <div class="field-selector">
              <select id="defaultTaxRate">
                <option value="">Choose an option</option>
                <option value="standard">Standard Rate</option>
                <option value="reduced">Reduced Rate</option>
                <option value="zero">Zero Rate</option>
                <option value="exempt">Tax Exempt</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <label class="form-label">
            Default account
            <span class="tooltip">
              <span class="info-icon">?</span>
              <span class="tooltiptext">Default income account for invoice line items</span>
            </span>
          </label>
          <div class="form-control">
            <div class="field-selector">
              <select id="defaultAccount">
                <option value="">Choose an option</option>
                <option value="sales">Sales</option>
                <option value="services">Services</option>
                <option value="consulting">Consulting</option>
                <option value="other">Other Income</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <h3>QuickBooks preferences</h3>
        
        <div class="form-row">
          <label class="form-label">
            User access
            <span class="tooltip">
              <span class="info-icon">?</span>
              <span class="tooltiptext">Control which users can create QuickBooks invoices</span>
            </span>
          </label>
          <div class="form-control">
            <div class="field-selector">
              <select id="userAccess">
                <option value="all" selected>All users</option>
                <option value="admin">Admin only</option>
                <option value="selected">Selected users</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-secondary" onclick="goBack()">Back</button>
        <button class="btn btn-primary" onclick="saveAllSettings()">Save & Finish</button>
      </div>
    </div>
    
    <!-- Loading State -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p style="margin-top: 20px; color: #666;">Saving your preferences...</p>
    </div>
    
    <!-- Success Message -->
    <div class="success-message" id="success">
      <div class="success-icon">✓</div>
      <h2>Setup Complete!</h2>
      <p style="color: #666; margin: 20px 0;">
        Your QuickBooks integration is now configured and ready to use.
      </p>
      <button class="btn btn-primary" onclick="finish()">Go to Pipedrive</button>
    </div>
  </div>
  
  <script>
    let currentStep = 1;
    let setupData = {
      authorizeAllUsers: false,
      preferences: {}
    };
    
    // Get userId and token from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId') || '';
    const token = urlParams.get('token') || '';
    
    // Security check - both token and userId must be present
    if (!token || !userId) {
      alert('Invalid setup session. Please reconnect to QuickBooks.');
      window.location.href = '/';
    }
    
    function saveAuthorization() {
      setupData.authorizeAllUsers = document.getElementById('authorizeUsers').checked;
      goToStep2();
    }
    
    function skipAuthorization() {
      setupData.authorizeAllUsers = false;
      goToStep2();
    }
    
    function goToStep2() {
      currentStep = 2;
      
      // Update step indicators
      document.getElementById('step1-indicator').classList.remove('active');
      document.getElementById('step1-indicator').classList.add('completed');
      document.getElementById('step2-indicator').classList.add('active');
      
      // Update content
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
    }
    
    function goBack() {
      currentStep = 1;
      
      // Update step indicators
      document.getElementById('step1-indicator').classList.add('active');
      document.getElementById('step1-indicator').classList.remove('completed');
      document.getElementById('step2-indicator').classList.remove('active');
      
      // Update content
      document.getElementById('step1').classList.add('active');
      document.getElementById('step2').classList.remove('active');
    }
    
    async function savePreferences() {
      // Collect preferences
      setupData.preferences = {
        contactField: document.getElementById('contactField').value,
        addressField: document.getElementById('addressField').value,
        emailField: document.getElementById('emailField').value,
        taxIdField: document.getElementById('taxIdField').value,
        dueDateDays: document.getElementById('dueDateDays').value,
        dueDateType: document.getElementById('dueDateType').value,
        defaultTaxRate: document.getElementById('defaultTaxRate').value,
        defaultAccount: document.getElementById('defaultAccount').value,
        userAccess: document.getElementById('userAccess').value
      };
      
      // Show loading
      document.getElementById('step2').classList.remove('active');
      document.getElementById('loading').classList.add('active');
      
      try {
        // Save preferences to backend with secure token
        const response = await fetch('/api/setup/preferences', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            token: token,  // Include the secure token for authentication
            ...setupData
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to save preferences');
        }
        
        // Show success
        setTimeout(() => {
          document.getElementById('loading').classList.remove('active');
          document.getElementById('success').classList.add('active');
          
          // Mark setup as complete
          document.getElementById('step2-indicator').classList.add('completed');
        }, 1000);
        
      } catch (error) {
        console.error('Error saving preferences:', error);
        alert('Failed to save preferences. Please try again.');
        document.getElementById('loading').classList.remove('active');
        document.getElementById('step2').classList.add('active');
      }
    }
    
    function finish() {
      // If we're in an extension context, close the window
      if (window.opener) {
        window.close();
      } else {
        // Otherwise redirect to success page
        window.location.href = '/setup-complete';
      }
    }
    
    async function saveAllSettings() {
      // Collect Step 2 preferences
      setupData.preferences = {
        contactField: document.getElementById('contactField').value,
        addressField: document.getElementById('addressField').value,
        emailField: document.getElementById('emailField').value,
        taxIdField: document.getElementById('taxIdField').value,
        dueDateDays: document.getElementById('dueDateDays').value,
        dueDateType: document.getElementById('dueDateType').value,
        defaultTaxRate: document.getElementById('defaultTaxRate').value,
        defaultAccount: document.getElementById('defaultAccount').value,
        userAccess: document.getElementById('userAccess').value
      };
      
      // Show loading
      document.getElementById('step2').classList.remove('active');
      document.getElementById('loading').classList.add('active');
      
      try {
        // Save all preferences to backend with secure token
        const response = await fetch('/api/setup/preferences', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            token: token,
            ...setupData
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to save preferences');
        }
        
        // Show success
        setTimeout(() => {
          document.getElementById('loading').classList.remove('active');
          document.getElementById('success').classList.add('active');
          
          // Mark setup as complete
          document.getElementById('step2-indicator').classList.add('completed');
        }, 1000);
        
      } catch (error) {
        console.error('Error saving preferences:', error);
        alert('Failed to save preferences. Please try again.');
        document.getElementById('loading').classList.remove('active');
        document.getElementById('step2').classList.add('active');
      }
    }
    
    // Auto-populate some fields with defaults for demo
    document.getElementById('dueDateDays').value = '30';
    document.getElementById('contactField').value = 'name';
    document.getElementById('addressField').value = 'address';
    document.getElementById('emailField').value = 'email';
  </script>
</body>
</html>