<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Connect QuickBooks - Pipedrive App</title>
    <script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@latest/dist/index.umd.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
      }

      h2 {
        color: #333;
        margin-bottom: 20px;
      }

      p {
        color: #666;
        line-height: 1.6;
        margin-bottom: 30px;
      }

      .status-container {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .status-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
      }

      .status-active {
        color: #28a745;
        font-size: 18px;
        font-weight: bold;
        margin: 10px 0;
      }

      .status-inactive {
        color: #dc3545;
        font-size: 18px;
        font-weight: bold;
        margin: 10px 0;
      }

      button {
        background: #007cba;
        color: white;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        border-radius: 4px;
        transition: background-color 0.3s;
        margin-top: 15px;
      }

      button:hover {
        background: #005a8b;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .button-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      .btn-disconnect {
        background: #dc3545;
      }

      .btn-disconnect:hover {
        background: #c82333;
      }

      .btn-confirm {
        background: #ff0000 !important;
        animation: pulse 0.5s;
        font-weight: bold;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .btn-reconnect {
        background: #28a745;
      }

      .btn-reconnect:hover {
        background: #218838;
      }

      .company-name {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }

      .section-divider {
        border-top: 1px solid #e0e0e0;
        margin: 30px 0;
      }

      .settings-section {
        margin-bottom: 30px;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .section-icon {
        width: 32px;
        height: 32px;
        background: #2ca01c;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
      }

      .section-icon.shipstation {
        background: #84c225;
      }

      h3 {
        color: #333;
        margin: 0;
        font-size: 18px;
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
      }

      .input-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #40a9ff;
        box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
      }

      .input-group input:disabled {
        background: #f5f5f5;
        color: #999;
      }

      .btn-test {
        background: #f5f5f5;
        color: #333;
        border: 1px solid #d9d9d9;
      }

      .btn-test:hover {
        background: #e8e8e8;
      }

      .btn-save {
        background: #84c225;
      }

      .btn-save:hover {
        background: #6ba01c;
      }

      .connection-result {
        margin-top: 10px;
        font-size: 13px;
        min-height: 20px;
      }

      .connection-result.success {
        color: #28a745;
      }

      .connection-result.error {
        color: #dc3545;
      }

      .shipstation-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .info-text {
        font-size: 12px;
        color: #888;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="settings-section">
      <div class="section-header">
        <div class="section-icon">QB</div>
        <h3>QuickBooks</h3>
      </div>
      <p style="color: #666; margin-bottom: 15px;">Link your Pipedrive to QuickBooks to sync contacts and invoices.</p>

      <div class="status-container">
      <div class="status-label">QuickBooks Connection Status:</div>
      <div id="statusText" class="status-inactive">Checking...</div>
      <div id="companyName" class="company-name" style="display: none"></div>
      <button id="connectBtn" style="display: none">
        Connect to QuickBooks
      </button>
      <div id="connectedActions" class="button-group" style="display: none">
        <button id="reconnectBtn" class="btn-reconnect">Reconnect</button>
        <button id="disconnectBtn" class="btn-disconnect">Disconnect</button>
      </div>
    </div>
    </div>

    <div class="section-divider"></div>

    <div class="settings-section">
      <div class="section-header">
        <div class="section-icon shipstation">SS</div>
        <h3>ShipStation</h3>
      </div>
      <p style="color: #666; margin-bottom: 15px;">Connect ShipStation to automatically create shipping orders from invoices.</p>

      <div id="shipstationStatus" class="status-container">
        <div class="status-label">ShipStation Connection Status:</div>
        <div id="ssStatusText" class="status-inactive">Checking...</div>
      </div>

      <div id="shipstationForm" style="display: none;">
        <div class="input-group">
          <label for="ssApiKey">API Key</label>
          <input type="text" id="ssApiKey" placeholder="Enter your ShipStation API Key">
        </div>
        <div class="input-group">
          <label for="ssApiSecret">API Secret</label>
          <input type="password" id="ssApiSecret" placeholder="Enter your ShipStation API Secret">
        </div>
        <p class="info-text">Find your API keys in ShipStation: Settings > Account > API Settings</p>
        <div class="shipstation-actions">
          <button id="ssTestBtn" class="btn-test">Test Connection</button>
          <button id="ssSaveBtn" class="btn-save" style="display: none;">Save Credentials</button>
        </div>
        <div id="ssConnectionResult" class="connection-result"></div>
      </div>

      <div id="shipstationConnected" style="display: none;">
        <div class="button-group" style="justify-content: flex-start;">
          <button id="ssDisconnectBtn" class="btn-disconnect">Disconnect</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize Pipedrive SDK
        const sdk = await new AppExtensionsSDK().initialize();

        // Get signed token and user info from Pipedrive SDK
        // Track both identifiers: companyDomain (subdomain) and numericUserId
        let companyDomain = "";  // e.g., "onitathlere" (the company subdomain)
        let numericUserId = "";   // e.g., "23527284" (the numeric Pipedrive user ID)
        let userId = "test";      // Primary identifier for API calls

        try {
          // Try to get the signed token
          const token = await sdk.execute("GET_SIGNED_TOKEN");
          console.log("Token received:", JSON.stringify(token));

          // Try multiple ways to extract user identification
          if (token) {
            // Check for api_domain in various places
            if (token.api_domain) {
              const domain = token.api_domain.replace(/\.pipedrive\.com$/, '').replace(/^https?:\/\//, '');
              companyDomain = domain;
              console.log("Found company domain from api_domain:", companyDomain);
            } else if (token.data && token.data.api_domain) {
              const domain = token.data.api_domain.replace(/\.pipedrive\.com$/, '').replace(/^https?:\/\//, '');
              companyDomain = domain;
              console.log("Found company domain from token.data.api_domain:", companyDomain);
            }
          }

          // Try to get context for additional info
          try {
            const context = await sdk.execute("GET_CONTEXT");
            console.log("Context received:", JSON.stringify(context));

            // Check if context has user info
            if (context) {
              // Get company_domain (the subdomain like "onitathlere")
              if (context.company_domain && !companyDomain) {
                companyDomain = context.company_domain;
                console.log("Using company_domain from context:", companyDomain);
              }

              if (context.user) {
                // Get numeric user ID if available
                if (context.user.id) {
                  numericUserId = String(context.user.id);
                  console.log("Found numeric user ID from context.user.id:", numericUserId);
                }
                if (context.user.company_domain && !companyDomain) {
                  companyDomain = context.user.company_domain;
                  console.log("Using user.company_domain from context:", companyDomain);
                }
              }
            }
          } catch (contextError) {
            console.log("Could not get context:", contextError);
          }
        } catch (error) {
          console.error("Error getting SDK data:", error);
        }

        // Check URL params for numeric userId (this is what Pipedrive passes)
        const urlParams = new URLSearchParams(window.location.search);
        const urlUserId = urlParams.get("userId");
        if (urlUserId && urlUserId !== "test") {
          // If it looks like a numeric ID (no dots), save as numericUserId
          if (!urlUserId.includes('.') && !numericUserId) {
            numericUserId = urlUserId;
            console.log("Found numeric userId from URL params:", numericUserId);
          }
        }

        // Extract company domain from the parent URL if we still don't have it
        if (!companyDomain) {
          try {
            // Check if we're in an iframe and can access parent URL
            if (window.parent !== window) {
              const parentUrl = document.referrer;
              console.log("Parent URL:", parentUrl);
              const match = parentUrl.match(
                /https:\/\/([^\.]+)\.pipedrive\.com/,
              );
              if (match) {
                companyDomain = match[1]; // Just the subdomain part
                console.log("Extracted companyDomain from parent URL:", companyDomain);
              }
            }
          } catch (e) {
            console.log("Could not access parent URL");
          }
        }

        // Set primary userId - prefer companyDomain, fall back to numericUserId
        if (companyDomain) {
          userId = companyDomain;
        } else if (numericUserId) {
          userId = numericUserId;
        }

        console.log("Final identifiers - userId:", userId, ", companyDomain:", companyDomain, ", numericUserId:", numericUserId);

        const statusText = document.getElementById("statusText");
        const companyNameDiv = document.getElementById("companyName");
        const connectBtn = document.getElementById("connectBtn");
        const connectedActions = document.getElementById("connectedActions");
        const reconnectBtn = document.getElementById("reconnectBtn");
        const disconnectBtn = document.getElementById("disconnectBtn");

        console.log("Button elements found:", {
          connectBtn: !!connectBtn,
          reconnectBtn: !!reconnectBtn,
          disconnectBtn: !!disconnectBtn,
          connectedActions: !!connectedActions,
        });

        // Polling state management - MUST be defined before handleConnect
        var pollingInterval = null;
        var pollAttempts = 0;
        var MAX_POLL_ATTEMPTS = 15; // 30 seconds at 2-second intervals
        var lastKnownStatus = null; // Track last status to detect changes

        // Start polling for status updates
        function startPolling() {
          console.log("Starting status polling...");
          pollAttempts = 0;

          // Clear any existing polling
          stopPolling();

          // Start new polling interval
          pollingInterval = setInterval(function () {
            pollAttempts++;
            console.log(
              "Polling attempt",
              pollAttempts,
              "of",
              MAX_POLL_ATTEMPTS,
            );

            checkStatus();

            // Stop polling after max attempts
            if (pollAttempts >= MAX_POLL_ATTEMPTS) {
              console.log("Max polling attempts reached, stopping polling");
              stopPolling();
            }
          }, 2000); // Poll every 2 seconds

          // Also do an immediate check
          checkStatus();
        }

        // Stop polling
        function stopPolling() {
          if (pollingInterval) {
            console.log("Stopping polling");
            clearInterval(pollingInterval);
            pollingInterval = null;
            pollAttempts = 0;
          }
        }

        // Listen for messages from OAuth callback window
        window.addEventListener("message", function (event) {
          if (event.data && event.data.source === "qb-callback") {
            if (event.data.success === true) {
              console.log("Received OAuth callback success message");
              // Send toast notification (wrapped in try/catch for settings panel compatibility)
              try {
                sdk.execute("SHOW_SNACKBAR", {
                  message: "QuickBooks Connected Successfully!",
                });
              } catch (e) {
                console.log("Toast notification not available in this context");
              }

              // Stop polling and do immediate refresh
              stopPolling();
              setTimeout(function () {
                console.log("Refreshing status after OAuth connection...");
                checkStatus();
              }, 500);

              // Close modal after a delay
              setTimeout(function () {
                sdk.execute("CLOSE_MODAL");
              }, 2000);
            }
          }
        });

        // Handle connect button
        function handleConnect() {
          let authUrl = "/auth/qb?user_id=" + userId + "&extension=true";
          if (companyDomain) authUrl += "&company_domain=" + companyDomain;
          if (numericUserId) authUrl += "&numeric_user_id=" + numericUserId;
          var popup = window.open(authUrl, "_blank", "width=600,height=700");

          // Simple approach: watch for popup to close, then reload the page
          // This is more reliable than polling or postMessage in sandboxed iframes
          console.log("Opened OAuth popup, watching for it to close...");

          var checkPopupClosed = setInterval(function () {
            try {
              if (!popup || popup.closed) {
                console.log(
                  "Popup closed, reloading page to refresh status...",
                );
                clearInterval(checkPopupClosed);
                // Give the server a moment to process, then reload
                setTimeout(function () {
                  window.location.reload();
                }, 1000);
              }
            } catch (e) {
              // Cross-origin errors can happen, just keep checking
            }
          }, 500);
        }

        // Attach button handlers
        if (reconnectBtn) {
          console.log("Attaching reconnect button handler");
          reconnectBtn.addEventListener("click", function () {
            console.log("Reconnect button clicked");
            handleConnect();
          });
        } else {
          console.error("Reconnect button not found!");
        }

        if (disconnectBtn) {
          console.log("Attaching disconnect button handler");

          // Track confirmation state
          let confirmationPending = false;
          let confirmationTimeout = null;

          // Function to reset button state
          function resetDisconnectButton() {
            confirmationPending = false;
            disconnectBtn.textContent = "Disconnect";
            disconnectBtn.classList.remove("btn-confirm");
            disconnectBtn.style.background = ""; // Reset inline style
            if (confirmationTimeout) {
              clearTimeout(confirmationTimeout);
              confirmationTimeout = null;
            }
          }

          disconnectBtn.addEventListener("click", async function (event) {
            event.preventDefault();
            console.log("Disconnect button clicked - event listener triggered");
            console.log("Current userId:", userId);
            console.log("Confirmation pending:", confirmationPending);

            // First click - show confirmation
            if (!confirmationPending) {
              console.log("First click - showing confirmation");
              confirmationPending = true;
              disconnectBtn.textContent = "⚠️ Click again to confirm";
              disconnectBtn.classList.add("btn-confirm");

              // Reset after 3 seconds if not confirmed
              confirmationTimeout = setTimeout(() => {
                console.log("Confirmation timed out, resetting button");
                resetDisconnectButton();
              }, 3000);

              return;
            }

            // Second click - actually disconnect
            console.log("Second click - performing disconnect");
            resetDisconnectButton();

            try {
              statusText.textContent = "Disconnecting...";
              disconnectBtn.disabled = true;
              reconnectBtn.disabled = true;

              // Try to get a signed token from SDK for authentication (optional)
              // Note: GET_SIGNED_TOKEN may not be available in all Pipedrive extension contexts
              let authToken = null;
              try {
                console.log(
                  "Attempting to get authentication token (optional)...",
                );
                // Try different SDK commands that might work
                try {
                  // This command may not exist in all contexts
                  const token = await sdk.execute("GET_SIGNED_TOKEN");
                  authToken = JSON.stringify(token);
                  console.log("Got signed token successfully");
                } catch (tokenError) {
                  // Try getting context as fallback
                  const context = await sdk.execute("GET_CONTEXT");
                  if (context) {
                    authToken = JSON.stringify({ context: context });
                    console.log("Using context as authentication");
                  }
                }
              } catch (e) {
                console.log(
                  "No authentication token available, proceeding without (server allows this for disconnect)",
                );
              }

              console.log("Sending disconnect request to server...");
              const response = await fetch("/api/disconnect-qb", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-Pipedrive-Token": authToken || "",
                },
                body: JSON.stringify({ userId: userId }),
              });

              console.log("Response status:", response.status);
              const data = await response.json();
              console.log("Response data:", data);

              if (data.success) {
                console.log("Disconnect successful");
                try {
                  sdk.execute("SHOW_SNACKBAR", {
                    message: "QuickBooks disconnected successfully",
                  });
                } catch (e) {
                  console.log("Toast notification not available in this context");
                }

                // Simple approach: just reload the page after a brief delay
                // This is more reliable than polling for status changes
                console.log("Reloading page to refresh status...");
                setTimeout(function () {
                  window.location.reload();
                }, 500);
              } else {
                console.error("Disconnect failed:", data.error);
                try {
                  sdk.execute("SHOW_SNACKBAR", {
                    message:
                      "Failed to disconnect: " + (data.error || "Unknown error"),
                  });
                } catch (e) {
                  console.log("Toast notification not available in this context");
                }
                statusText.textContent = "Active";
              }
            } catch (error) {
              console.error("Error in disconnect handler:", error);
              console.error("Error stack:", error.stack);

              // Try to show toast even if there's an error
              try {
                sdk.execute("SHOW_SNACKBAR", {
                  message: "Error disconnecting QuickBooks",
                });
              } catch (toastError) {
                console.error("Could not show toast:", toastError);
              }

              statusText.textContent = "Active";
            } finally {
              // Re-enable buttons
              disconnectBtn.disabled = false;
              reconnectBtn.disabled = false;
              resetDisconnectButton();
            }
          });

          // Reset confirmation if user clicks elsewhere
          document.addEventListener("click", function (event) {
            if (confirmationPending && event.target !== disconnectBtn) {
              console.log(
                "Click outside disconnect button, resetting confirmation",
              );
              resetDisconnectButton();
            }
          });
        } else {
          console.error("Disconnect button not found!");
        }

        // Check connection status
        function checkStatus() {
          console.log("Checking status for userId:", userId, "companyDomain:", companyDomain, "numericUserId:", numericUserId);
          const statusParams = new URLSearchParams({ userId: userId });
          if (companyDomain) statusParams.append('companyDomain', companyDomain);
          if (numericUserId) statusParams.append('numericUserId', numericUserId);
          fetch("/api/user-status?" + statusParams.toString())
            .then(function (response) {
              return response.json();
            })
            .then(function (data) {
              console.log(
                "User status response:",
                JSON.stringify(data, null, 2),
              );
              if (data.debug) {
                console.log("Debug info:", data.debug);
              }

              // Track if status changed
              var statusChanged = lastKnownStatus !== data.connected;
              if (statusChanged) {
                console.log(
                  "Status changed from",
                  lastKnownStatus,
                  "to",
                  data.connected,
                );
              }
              lastKnownStatus = data.connected;

              if (data.connected === true) {
                // Stop polling if we're connected
                if (pollingInterval) {
                  console.log("Connected status detected, stopping polling");
                  stopPolling();
                }
                console.log("User is connected, showing connected UI");
                // Show connected state
                statusText.textContent = "Active";
                statusText.className = "status-active";

                // Show company name if available
                if (data.companyName) {
                  companyNameDiv.textContent = data.companyName;
                  companyNameDiv.style.display = "block";
                  console.log("Displaying company name:", data.companyName);
                } else {
                  companyNameDiv.style.display = "none";
                }

                // Hide connect button, show disconnect/reconnect buttons
                connectBtn.style.display = "none";
                connectedActions.style.display = "flex";
                console.log(
                  "Buttons visible - Reconnect/Disconnect should be clickable",
                );
              } else {
                console.log("User is not connected, showing connect UI");

                // Stop polling if we detect disconnected status
                if (pollingInterval) {
                  console.log("Disconnected status detected, stopping polling");
                  stopPolling();
                }

                // Check if it's due to expired tokens
                if (data.tokenExpired === true) {
                  console.log("Token expired, showing reconnect UI");
                  // Show expired state
                  statusText.textContent = "QB Session Expired";
                  statusText.className = "status-inactive";
                  companyNameDiv.style.display = "none";

                  // Show reconnect button with appropriate text
                  connectBtn.style.display = "inline-block";
                  connectBtn.textContent = "Reconnect to QuickBooks";
                  connectBtn.onclick = handleConnect;
                  connectedActions.style.display = "none";
                } else {
                  // Show disconnected state
                  statusText.textContent = "Inactive";
                  statusText.className = "status-inactive";
                  companyNameDiv.style.display = "none";

                  // Show connect button, hide disconnect/reconnect buttons
                  connectBtn.style.display = "inline-block";
                  connectBtn.textContent = "Connect to QuickBooks";
                  connectBtn.onclick = handleConnect;
                  connectedActions.style.display = "none";
                }
              }
            })
            .catch(function (error) {
              console.error("Error checking status:", error);
              statusText.textContent = "Status Unknown";
              statusText.className = "status-inactive";
              companyNameDiv.style.display = "none";

              // Show connect button on error
              connectBtn.style.display = "inline-block";
              connectBtn.textContent = "Connect to QuickBooks";
              connectBtn.onclick = handleConnect;
              connectedActions.style.display = "none";
            });
        }

        // Initial status check
        checkStatus();

        // ============== ShipStation Section ==============
        const ssStatusText = document.getElementById('ssStatusText');
        const shipstationForm = document.getElementById('shipstationForm');
        const shipstationConnected = document.getElementById('shipstationConnected');
        const ssApiKeyInput = document.getElementById('ssApiKey');
        const ssApiSecretInput = document.getElementById('ssApiSecret');
        const ssTestBtn = document.getElementById('ssTestBtn');
        const ssSaveBtn = document.getElementById('ssSaveBtn');
        const ssDisconnectBtn = document.getElementById('ssDisconnectBtn');
        const ssConnectionResult = document.getElementById('ssConnectionResult');

        // Track if credentials have been tested successfully
        let ssCredentialsTested = false;

        // Check ShipStation status
        async function checkShipStationStatus() {
          try {
            const ssParams = new URLSearchParams({ userId: userId });
            if (companyDomain) ssParams.append('companyDomain', companyDomain);
            if (numericUserId) ssParams.append('numericUserId', numericUserId);
            const response = await fetch('/api/shipstation/status?' + ssParams.toString());
            const data = await response.json();

            if (data.connected) {
              ssStatusText.textContent = 'Active';
              ssStatusText.className = 'status-active';
              shipstationForm.style.display = 'none';
              shipstationConnected.style.display = 'block';
            } else {
              ssStatusText.textContent = 'Not Connected';
              ssStatusText.className = 'status-inactive';
              shipstationForm.style.display = 'block';
              shipstationConnected.style.display = 'none';
            }
          } catch (error) {
            console.error('Error checking ShipStation status:', error);
            ssStatusText.textContent = 'Not Connected';
            ssStatusText.className = 'status-inactive';
            shipstationForm.style.display = 'block';
            shipstationConnected.style.display = 'none';
          }
        }

        // Test ShipStation connection
        ssTestBtn.addEventListener('click', async function() {
          const apiKey = ssApiKeyInput.value.trim();
          const apiSecret = ssApiSecretInput.value.trim();

          if (!apiKey || !apiSecret) {
            ssConnectionResult.textContent = 'Please enter both API Key and Secret';
            ssConnectionResult.className = 'connection-result error';
            return;
          }

          ssTestBtn.disabled = true;
          ssTestBtn.textContent = 'Testing...';
          ssConnectionResult.textContent = '';

          try {
            const response = await fetch('/api/shipstation/test', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ apiKey, apiSecret })
            });

            const data = await response.json();

            if (response.ok && data.success) {
              ssConnectionResult.textContent = 'Connection successful! Click Save to store your credentials.';
              ssConnectionResult.className = 'connection-result success';
              ssSaveBtn.style.display = 'inline-block';
              ssCredentialsTested = true;
            } else {
              ssConnectionResult.textContent = data.error || 'Connection failed. Please check your credentials.';
              ssConnectionResult.className = 'connection-result error';
              ssSaveBtn.style.display = 'none';
              ssCredentialsTested = false;
            }
          } catch (error) {
            ssConnectionResult.textContent = 'Connection failed: ' + error.message;
            ssConnectionResult.className = 'connection-result error';
            ssSaveBtn.style.display = 'none';
            ssCredentialsTested = false;
          }

          ssTestBtn.disabled = false;
          ssTestBtn.textContent = 'Test Connection';
        });

        // Save ShipStation credentials
        ssSaveBtn.addEventListener('click', async function() {
          if (!ssCredentialsTested) {
            ssConnectionResult.textContent = 'Please test the connection first';
            ssConnectionResult.className = 'connection-result error';
            return;
          }

          const apiKey = ssApiKeyInput.value.trim();
          const apiSecret = ssApiSecretInput.value.trim();

          ssSaveBtn.disabled = true;
          ssSaveBtn.textContent = 'Saving...';

          try {
            // Get auth token for security
            let authToken = null;
            try {
              const token = await sdk.execute('GET_SIGNED_TOKEN');
              authToken = JSON.stringify(token);
            } catch (e) {
              console.log('Could not get signed token, proceeding without');
            }

            const response = await fetch('/api/shipstation/save', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'X-Pipedrive-Token': authToken || ''
              },
              body: JSON.stringify({ userId, apiKey, apiSecret })
            });

            const data = await response.json();

            if (response.ok && data.success) {
              try {
                sdk.execute('SHOW_SNACKBAR', { message: 'ShipStation connected successfully!' });
              } catch (e) {
                console.log('Toast notification not available in this context');
              }
              // Refresh the status
              checkShipStationStatus();
              // Clear the form
              ssApiKeyInput.value = '';
              ssApiSecretInput.value = '';
              ssCredentialsTested = false;
              // Also show success in the result area
              ssConnectionResult.textContent = 'Connected successfully!';
              ssConnectionResult.className = 'connection-result success';
            } else {
              ssConnectionResult.textContent = data.error || 'Failed to save credentials';
              ssConnectionResult.className = 'connection-result error';
            }
          } catch (error) {
            console.error('ShipStation save error:', error);
            ssConnectionResult.textContent = 'Failed to save credentials. Please try again.';
            ssConnectionResult.className = 'connection-result error';
          }

          ssSaveBtn.disabled = false;
          ssSaveBtn.textContent = 'Save Credentials';
        });

        // Disconnect ShipStation
        let ssDisconnectPending = false;
        ssDisconnectBtn.addEventListener('click', async function() {
          if (!ssDisconnectPending) {
            ssDisconnectPending = true;
            ssDisconnectBtn.textContent = 'Click again to confirm';
            ssDisconnectBtn.classList.add('btn-confirm');
            setTimeout(() => {
              ssDisconnectPending = false;
              ssDisconnectBtn.textContent = 'Disconnect';
              ssDisconnectBtn.classList.remove('btn-confirm');
            }, 3000);
            return;
          }

          ssDisconnectPending = false;
          ssDisconnectBtn.disabled = true;
          ssDisconnectBtn.textContent = 'Disconnecting...';

          try {
            // Get auth token for security
            let authToken = null;
            try {
              const token = await sdk.execute('GET_SIGNED_TOKEN');
              authToken = JSON.stringify(token);
            } catch (e) {
              console.log('Could not get signed token, proceeding without');
            }

            const response = await fetch('/api/shipstation/disconnect', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'X-Pipedrive-Token': authToken || ''
              },
              body: JSON.stringify({ userId })
            });

            const data = await response.json();

            if (response.ok && data.success) {
              try {
                sdk.execute('SHOW_SNACKBAR', { message: 'ShipStation disconnected' });
              } catch (e) {
                console.log('Toast notification not available in this context');
              }
              checkShipStationStatus();
            } else {
              console.error('Disconnect failed:', data.error);
            }
          } catch (error) {
            console.error('Disconnect error:', error);
          }

          ssDisconnectBtn.disabled = false;
          ssDisconnectBtn.textContent = 'Disconnect';
          ssDisconnectBtn.classList.remove('btn-confirm');
        });

        // Initial ShipStation status check
        checkShipStationStatus();
      });
    </script>
  </body>
</html>
