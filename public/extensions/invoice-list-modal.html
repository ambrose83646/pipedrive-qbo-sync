<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoices - QuickBooks</title>
  <script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@latest/dist/index.umd.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
      background: #f5f5f5;
    }
    
    .modal-container {
      min-height: 100vh;
      padding: 24px;
      background: white;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 24px;
    }
    
    .modal-header-left {
      flex: 1;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .modal-subtitle {
      font-size: 13px;
      color: #8c8c8c;
      margin-top: 4px;
    }
    
    .date-range-badge {
      display: inline-block;
      background: #f0f0f0;
      color: #595959;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .btn-close {
      background: transparent;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      color: #595959;
    }
    
    .btn-close:hover {
      background: #f5f5f5;
    }
    
    .overview-summary {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
      padding: 16px;
      background: #fafafa;
      border-radius: 8px;
    }
    
    .overview-item {
      flex: 1;
      text-align: center;
    }
    
    .overview-value {
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .overview-value.outstanding {
      color: #fa8c16;
    }
    
    .overview-value.overdue {
      color: #f5222d;
    }
    
    .overview-value.paid {
      color: #52c41a;
    }
    
    .overview-label {
      font-size: 12px;
      color: #8c8c8c;
      margin-top: 4px;
    }
    
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .invoice-table th,
    .invoice-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .invoice-table th {
      background: #fafafa;
      font-weight: 600;
      font-size: 12px;
      color: #8c8c8c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .invoice-table tr:hover {
      background: #f9f9f9;
    }
    
    .invoice-number {
      font-weight: 500;
      color: #1890ff;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-paid {
      background: #f6ffed;
      color: #52c41a;
    }
    
    .status-open {
      background: #fff7e6;
      color: #fa8c16;
    }
    
    .status-overdue {
      background: #fff1f0;
      color: #f5222d;
    }
    
    .amount-cell {
      font-weight: 500;
      text-align: right !important;
    }
    
    .balance-cell {
      text-align: right !important;
    }
    
    .action-btn {
      background: transparent;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      color: #595959;
    }
    
    .action-btn:hover {
      background: #f5f5f5;
      border-color: #1890ff;
      color: #1890ff;
    }
    
    .action-btn-download {
      margin-left: 4px;
      background: #f0f5ff;
      border-color: #adc6ff;
      color: #1890ff;
    }
    
    .action-btn-download:hover {
      background: #e6f0ff;
      border-color: #1890ff;
    }
    
    .action-btn-download:disabled {
      background: #f5f5f5;
      color: #bfbfbf;
      border-color: #d9d9d9;
      cursor: wait;
    }
    
    .action-btn-paylink {
      margin-left: 4px;
      background: #f6ffed;
      border-color: #b7eb8f;
      color: #52c41a;
    }
    
    .action-btn-paylink:hover {
      background: #d9f7be;
      border-color: #52c41a;
    }
    
    .action-btn-paylink:disabled {
      background: #f5f5f5;
      color: #bfbfbf;
      border-color: #d9d9d9;
      cursor: wait;
    }
    
    .action-btn-paylink.copied {
      background: #52c41a;
      border-color: #52c41a;
      color: white;
    }
    
    .shipment-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      gap: 4px;
    }
    
    .shipment-none {
      background: #f5f5f5;
      color: #8c8c8c;
    }
    
    .shipment-awaiting {
      background: #fff7e6;
      color: #d48806;
    }
    
    .shipment-transit {
      background: #e6f7ff;
      color: #1890ff;
    }
    
    .shipment-delivered {
      background: #f6ffed;
      color: #52c41a;
    }
    
    .shipment-pending-payment {
      background: #fff1f0;
      color: #cf1322;
    }
    
    .shipment-section {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }
    
    .shipment-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #595959;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .shipment-card {
      background: #fafafa;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .shipment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .tracking-link {
      color: #1890ff;
      text-decoration: none;
      font-size: 13px;
    }
    
    .tracking-link:hover {
      text-decoration: underline;
    }
    
    .shipment-items {
      font-size: 12px;
      color: #8c8c8c;
    }
    
    .shipment-order-number {
      font-size: 11px;
      color: #595959;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e8e8e8;
    }
    
    .shipment-order-number a {
      color: #1890ff;
      text-decoration: none;
    }
    
    .shipment-order-number a:hover {
      text-decoration: underline;
    }
    
    .shipment-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    
    .shipment-detail-item {
      font-size: 12px;
    }
    
    .shipment-detail-label {
      color: #8c8c8c;
      display: block;
      margin-bottom: 2px;
    }
    
    .shipment-detail-value {
      color: #262626;
      font-weight: 500;
    }
    
    .shipment-tracking-section {
      background: #e6f7ff;
      border-radius: 4px;
      padding: 8px 10px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .shipment-tracking-label {
      font-size: 11px;
      color: #1890ff;
      font-weight: 500;
    }
    
    .shipment-tracking-number {
      font-size: 13px;
      color: #1890ff;
      font-weight: 600;
      text-decoration: none;
    }
    
    .shipment-tracking-number:hover {
      text-decoration: underline;
    }
    
    .shipment-items-section {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid #e8e8e8;
    }
    
    .shipment-items-title {
      font-size: 11px;
      color: #8c8c8c;
      font-weight: 600;
      margin-bottom: 6px;
    }
    
    .shipment-item-row {
      font-size: 12px;
      color: #262626;
      padding: 2px 0;
    }
    
    .ss-connect-hint {
      background: #fffbe6;
      border: 1px solid #ffe58f;
      border-radius: 6px;
      padding: 12px;
      font-size: 13px;
      color: #ad6800;
      margin-top: 16px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8c8c8c;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .empty-state-subtext {
      font-size: 14px;
    }
    
    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: #8c8c8c;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid #f0f0f0;
      border-top-color: #1890ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .invoice-detail-panel {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 12px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .invoice-detail-panel.active {
      display: block;
    }
    
    .detail-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .detail-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .detail-close {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #8c8c8c;
    }
    
    .detail-body {
      padding: 20px;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .detail-label {
      color: #8c8c8c;
      font-size: 13px;
    }
    
    .detail-value {
      font-weight: 500;
      color: #1a1a1a;
    }
    
    .line-items-section {
      margin-top: 24px;
    }
    
    .line-items-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #595959;
    }
    
    .line-item-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .line-item-desc {
      flex: 1;
    }
    
    .line-item-name {
      font-weight: 500;
      color: #1a1a1a;
    }
    
    .line-item-qty {
      font-size: 12px;
      color: #8c8c8c;
      margin-top: 2px;
    }
    
    .line-item-amount {
      font-weight: 500;
      text-align: right;
    }
    
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 999;
    }
    
    .overlay.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-header-left">
        <h1 class="modal-title">Invoices</h1>
        <p class="modal-subtitle" id="customerName">Loading...</p>
        <div class="date-range-badge" id="dateRangeBadge">This Quarter</div>
      </div>
      <button class="btn-close" onclick="closeModal()">Close</button>
    </div>
    
    <div class="overview-summary" id="overviewSummary">
      <div class="overview-item">
        <div class="overview-value outstanding" id="summaryOutstanding">$0.00</div>
        <div class="overview-label">Outstanding</div>
      </div>
      <div class="overview-item">
        <div class="overview-value overdue" id="summaryOverdue">$0.00</div>
        <div class="overview-label">Overdue</div>
      </div>
      <div class="overview-item">
        <div class="overview-value paid" id="summaryPaid">$0.00</div>
        <div class="overview-label">Paid</div>
      </div>
      <div class="overview-item">
        <div class="overview-value" id="summaryTotal">$0.00</div>
        <div class="overview-label">Total</div>
      </div>
    </div>
    
    <div id="invoiceContent">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading invoices...</p>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="detailOverlay" onclick="closeDetail()"></div>
  <div class="invoice-detail-panel" id="detailPanel">
    <div class="detail-header">
      <span class="detail-title" id="detailTitle">Invoice #</span>
      <button class="detail-close" onclick="closeDetail()">&times;</button>
    </div>
    <div class="detail-body" id="detailBody">
    </div>
  </div>
  
  <script>
    let sdk = null;
    let invoices = [];
    let customerId = null;
    let userId = null;
    let customerName = '';
    let dateRange = { type: 'this_quarter', startDate: null, endDate: null };
    let shipmentData = {};
    let shipstationConnected = false;
    
    async function init() {
      try {
        sdk = await new AppExtensionsSDK().initialize({
          size: { width: 1000, height: 700 }
        });
        console.log('SDK initialized');
        
        const urlParams = new URLSearchParams(window.location.search);
        
        // Data is passed from OPEN_MODAL as a JSON string in the 'data' parameter
        const dataParam = urlParams.get('data');
        if (dataParam) {
          try {
            const data = JSON.parse(decodeURIComponent(dataParam));
            console.log('Parsed modal data:', data);
            customerId = data.customerId;
            userId = data.userId;
            customerName = data.customerName || 'Customer';
            dateRange.type = data.dateRangeType || 'this_quarter';
            dateRange.startDate = data.startDate;
            dateRange.endDate = data.endDate;
          } catch (parseError) {
            console.error('Error parsing data parameter:', parseError);
          }
        }
        
        // Fallback to individual query params if data param not present
        if (!customerId) customerId = urlParams.get('customerId');
        if (!userId) userId = urlParams.get('userId');
        if (!customerName) customerName = urlParams.get('customerName') || 'Customer';
        if (!dateRange.type) dateRange.type = urlParams.get('dateRangeType') || 'this_quarter';
        if (!dateRange.startDate) dateRange.startDate = urlParams.get('startDate');
        if (!dateRange.endDate) dateRange.endDate = urlParams.get('endDate');
        
        document.getElementById('customerName').textContent = customerName;
        document.getElementById('dateRangeBadge').textContent = getDateRangeLabel(dateRange.type);
        
        if (customerId && userId) {
          await loadInvoices();
        } else {
          showError('Missing customer or user information');
        }
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize: ' + error.message);
      }
    }
    
    function getDateRangeLabel(type) {
      switch(type) {
        case 'this_quarter': return 'This Quarter';
        case 'last_quarter': return 'Last Quarter';
        case 'this_year': return 'This Year';
        case 'custom': return 'Custom Range';
        default: return 'This Quarter';
      }
    }
    
    async function loadInvoices() {
      try {
        let url = `/api/customer/${customerId}/invoices?userId=${encodeURIComponent(userId)}`;
        
        if (dateRange.startDate) {
          url += `&startDate=${dateRange.startDate}`;
        }
        if (dateRange.endDate) {
          url += `&endDate=${dateRange.endDate}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
          invoices = data.invoices || [];
          updateOverviewSummary(data.overview);
          renderInvoiceTable();
          
          // Load shipment data after rendering initial table
          await loadShipmentData();
        } else {
          showError(data.error || 'Failed to load invoices');
        }
      } catch (error) {
        console.error('Error loading invoices:', error);
        showError('Failed to load invoices: ' + error.message);
      }
    }
    
    async function loadShipmentData() {
      console.log('[ShipStation Modal] loadShipmentData called, invoices count:', invoices.length);
      if (invoices.length === 0) {
        console.log('[ShipStation Modal] No invoices, skipping shipment data load');
        return;
      }
      
      // Debug: log first invoice structure to find correct property name
      if (invoices.length > 0) {
        console.log('[ShipStation Modal] First invoice keys:', Object.keys(invoices[0]));
        console.log('[ShipStation Modal] First invoice sample:', JSON.stringify(invoices[0]).substring(0, 500));
      }
      
      try {
        // Get all invoice DocNumbers to query ShipStation
        // Try multiple possible property names for invoice number
        const orderNumbers = invoices
          .map(inv => inv.DocNumber || inv.docNumber || inv.InvoiceNumber || inv.invoiceNumber || inv.Id || inv.id)
          .filter(Boolean)
          .join(',');
        
        console.log('[ShipStation Modal] Order numbers to query:', orderNumbers);
        
        if (!orderNumbers) {
          console.log('[ShipStation Modal] No order numbers, skipping');
          return;
        }
        
        const fetchUrl = `/api/shipstation/shipments?userId=${encodeURIComponent(userId)}&orderNumbers=${encodeURIComponent(orderNumbers)}`;
        console.log('[ShipStation Modal] Fetching:', fetchUrl);
        
        const response = await fetch(fetchUrl);
        console.log('[ShipStation Modal] Response status:', response.status);
        
        const data = await response.json();
        console.log('[ShipStation Modal] Response data:', data);
        
        if (data.success) {
          shipmentData = data.shipments || {};
          shipstationConnected = data.connected;
          console.log('[ShipStation Modal] ShipStation connected:', shipstationConnected, 'Shipments:', Object.keys(shipmentData).length);
          
          // Re-render table with shipment data
          renderInvoiceTable();
        } else {
          console.log('[ShipStation Modal] Response not successful:', data.error);
        }
      } catch (error) {
        console.error('[ShipStation Modal] Error loading shipment data:', error);
        // Continue without shipment data
      }
    }
    
    function getShipmentStatus(invoice) {
      // Use fallback chain to find invoice number - QuickBooks may return it in different fields
      const docNumber = invoice.DocNumber || invoice.docNumber || invoice.Id || invoice.id;
      const shipmentInfo = shipmentData[docNumber];
      
      if (!shipstationConnected) {
        return { label: '-', class: 'shipment-none', icon: '' };
      }
      
      // Handle both old array format and new object format
      const shipments = Array.isArray(shipmentInfo) ? shipmentInfo : (shipmentInfo?.shipments || []);
      const summary = shipmentInfo?.summary;
      
      if (!shipments || shipments.length === 0) {
        // Check payment terms - if "Due on Receipt" and not paid, show pending payment
        const balance = parseFloat(invoice.Balance || 0);
        const salesTermRef = invoice.SalesTermRef?.name || '';
        
        if (balance > 0 && salesTermRef.toLowerCase().includes('receipt')) {
          return { label: 'Pending Payment', class: 'shipment-pending-payment', icon: '‚è≥' };
        }
        return { label: 'No Order', class: 'shipment-none', icon: '' };
      }
      
      // Check for partial shipment using summary
      if (summary && summary.isPartiallyShipped) {
        return { 
          label: `${summary.totalShippedItems}/${summary.totalOrderItems} Shipped`, 
          class: 'shipment-transit', 
          icon: 'üì¶' 
        };
      }
      
      if (summary && summary.isFullyShipped) {
        // Check if any shipment is delivered
        const allDelivered = shipments.every(s => s.shipmentStatus === 'Delivered');
        if (allDelivered) {
          return { label: 'Delivered', class: 'shipment-delivered', icon: '‚úì' };
        }
        return { label: 'Shipped', class: 'shipment-transit', icon: 'üöö' };
      }
      
      const shipment = shipments[0];
      
      if (shipment.shipmentStatus === 'Delivered') {
        return { label: 'Delivered', class: 'shipment-delivered', icon: '‚úì' };
      }
      if (shipment.shipmentStatus === 'In Transit' || shipment.trackingNumber) {
        return { label: 'In Transit', class: 'shipment-transit', icon: 'üöö' };
      }
      if (shipment.shipmentStatus === 'Awaiting Shipment' || shipment.orderStatus === 'awaiting_shipment') {
        return { label: 'Awaiting', class: 'shipment-awaiting', icon: 'üì¶' };
      }
      
      return { label: shipment.shipmentStatus || 'Order Created', class: 'shipment-awaiting', icon: 'üì¶' };
    }
    
    function updateOverviewSummary(overview) {
      document.getElementById('summaryOutstanding').textContent = formatCurrency(overview.outstanding);
      document.getElementById('summaryOverdue').textContent = formatCurrency(overview.overdue);
      document.getElementById('summaryPaid').textContent = formatCurrency(overview.paid);
      document.getElementById('summaryTotal').textContent = formatCurrency(overview.total);
    }
    
    function formatCurrency(amount) {
      return '$' + (amount || 0).toFixed(2);
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      
      // Robust parsing: QuickBooks sends YYYY-MM-DD which JavaScript treats as UTC
      // This causes dates to display one day early in US time zones
      let date;
      if (dateStr.includes('T')) {
        // Already has time component (ISO format with timezone)
        date = new Date(dateStr);
      } else {
        // Date-only string like "2025-01-05" - parse as local midnight
        const [year, month, day] = dateStr.split('-').map(Number);
        date = new Date(year, month - 1, day);
      }
      
      if (isNaN(date.getTime())) return '-';
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function getInvoiceStatus(invoice) {
      const balance = parseFloat(invoice.Balance || 0);
      
      if (balance <= 0) {
        return { label: 'Paid', class: 'status-paid' };
      }
      
      // Guard against missing DueDate
      if (!invoice.DueDate) {
        return { label: 'Open', class: 'status-open' };
      }
      
      // Parse DueDate robustly - QuickBooks may send ISO strings or date-only strings
      let dueDate;
      if (invoice.DueDate.includes('T')) {
        // Already has time component (ISO format)
        dueDate = new Date(invoice.DueDate);
      } else {
        // Date-only string like "2025-01-05"
        dueDate = new Date(invoice.DueDate + 'T00:00:00');
      }
      
      // Check for invalid date
      if (isNaN(dueDate.getTime())) {
        return { label: 'Open', class: 'status-open' };
      }
      
      // Compare dates by stripping time components
      const dueDateOnly = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
      const today = new Date();
      const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      
      if (dueDateOnly < todayOnly) {
        return { label: 'Overdue', class: 'status-overdue' };
      } else {
        return { label: 'Open', class: 'status-open' };
      }
    }
    
    function renderInvoiceTable() {
      const container = document.getElementById('invoiceContent');
      
      if (invoices.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <div class="empty-state-text">No invoices found</div>
            <div class="empty-state-subtext">No invoices match the selected date range</div>
          </div>
        `;
        return;
      }
      
      let tableHtml = `
        <table class="invoice-table">
          <thead>
            <tr>
              <th>Invoice #</th>
              <th>Date</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Shipment</th>
              <th style="text-align: right;">Amount</th>
              <th style="text-align: right;">Balance</th>
              <th style="text-align: center;">Action</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      invoices.forEach(invoice => {
        const status = getInvoiceStatus(invoice);
        const shipStatus = getShipmentStatus(invoice);
        const invoiceNum = invoice.DocNumber || invoice.Id;
        
        tableHtml += `
          <tr>
            <td class="invoice-number">${invoiceNum}</td>
            <td>${formatDate(invoice.TxnDate)}</td>
            <td>${formatDate(invoice.DueDate)}</td>
            <td><span class="status-badge ${status.class}">${status.label}</span></td>
            <td><span class="shipment-badge ${shipStatus.class}">${shipStatus.icon} ${shipStatus.label}</span></td>
            <td class="amount-cell">${formatCurrency(invoice.TotalAmt)}</td>
            <td class="balance-cell">${formatCurrency(invoice.Balance)}</td>
            <td style="text-align: center;">
              <button class="action-btn" onclick="showInvoiceDetail('${invoice.Id}')" title="View Details">View</button>
              <button class="action-btn action-btn-download" onclick="downloadInvoicePdf('${invoice.Id}', '${invoiceNum}')" title="Download PDF">PDF</button>
              <button class="action-btn action-btn-paylink" onclick="copyPaymentLink('${invoice.Id}', '${invoiceNum}', this)" title="Copy Payment Link">Pay</button>
            </td>
          </tr>
        `;
      });
      
      tableHtml += '</tbody></table>';
      container.innerHTML = tableHtml;
    }
    
    async function showInvoiceDetail(invoiceId) {
      const invoice = invoices.find(inv => inv.Id === invoiceId);
      if (!invoice) return;
      
      // Always refresh shipment data for this specific invoice when opening detail
      // Use fallback chain since QuickBooks may return invoice number in different fields
      const docNumber = invoice.DocNumber || invoice.docNumber || invoice.Id || invoice.id;
      if (docNumber) {
        console.log('[ShipStation Modal] Fetching shipment data for invoice:', docNumber);
        try {
          const fetchUrl = `/api/shipstation/shipments?userId=${encodeURIComponent(userId)}&orderNumbers=${encodeURIComponent(docNumber)}`;
          const response = await fetch(fetchUrl);
          const data = await response.json();
          if (data.success) {
            shipstationConnected = data.connected;
            if (data.shipments) {
              Object.assign(shipmentData, data.shipments);
              console.log('[ShipStation Modal] Updated shipmentData with:', Object.keys(data.shipments));
            }
          }
        } catch (error) {
          console.error('[ShipStation Modal] Error refreshing shipment data:', error);
        }
      }
      
      const status = getInvoiceStatus(invoice);
      const invoiceNum = invoice.DocNumber || invoice.Id;
      
      document.getElementById('detailTitle').textContent = `Invoice #${invoiceNum}`;
      
      let detailHtml = `
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value"><span class="status-badge ${status.class}">${status.label}</span></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Invoice Date</span>
          <span class="detail-value">${formatDate(invoice.TxnDate)}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Due Date</span>
          <span class="detail-value">${formatDate(invoice.DueDate)}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Total Amount</span>
          <span class="detail-value">${formatCurrency(invoice.TotalAmt)}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Balance Due</span>
          <span class="detail-value">${formatCurrency(invoice.Balance)}</span>
        </div>
      `;
      
      if (invoice.BillEmail?.Address) {
        detailHtml += `
          <div class="detail-row">
            <span class="detail-label">Bill Email</span>
            <span class="detail-value">${invoice.BillEmail.Address}</span>
          </div>
        `;
      }
      
      if (invoice.ShipAddr) {
        const addr = invoice.ShipAddr;
        const addrParts = [
          addr.Line1,
          addr.Line2,
          [addr.City, addr.CountrySubDivisionCode, addr.PostalCode].filter(Boolean).join(', ')
        ].filter(Boolean);
        
        if (addrParts.length > 0) {
          detailHtml += `
            <div class="detail-row">
              <span class="detail-label">Ship To</span>
              <span class="detail-value">${addrParts.join('<br>')}</span>
            </div>
          `;
        }
      }
      
      if (invoice.CustomerMemo?.value) {
        detailHtml += `
          <div class="detail-row">
            <span class="detail-label">Memo</span>
            <span class="detail-value">${invoice.CustomerMemo.value}</span>
          </div>
        `;
      }
      
      if (invoice.PrivateNote) {
        detailHtml += `
          <div class="detail-row">
            <span class="detail-label">Private Note</span>
            <span class="detail-value">${invoice.PrivateNote}</span>
          </div>
        `;
      }
      
      if (invoice.Line && invoice.Line.length > 0) {
        detailHtml += `
          <div class="line-items-section">
            <div class="line-items-title">Line Items</div>
        `;
        
        invoice.Line.forEach(line => {
          let itemName = '';
          let itemDetail = '';
          let amount = line.Amount || 0;
          let showLine = true;
          
          switch(line.DetailType) {
            case 'SalesItemLineDetail':
              itemName = line.SalesItemLineDetail?.ItemRef?.name || line.Description || 'Item';
              const sku = line.SalesItemLineDetail?.Sku || '';
              if (sku) {
                itemName += ` <span style="color: #8c8c8c; font-size: 12px;">(SKU: ${sku})</span>`;
              }
              const qty = line.SalesItemLineDetail?.Qty || 1;
              const unitPrice = line.SalesItemLineDetail?.UnitPrice || line.Amount;
              itemDetail = `${qty} x ${formatCurrency(unitPrice)}`;
              // Check for markup/shipping context
              if (line.SalesItemLineDetail?.MarkupInfo) {
                const markupPct = line.SalesItemLineDetail.MarkupInfo.Percent;
                if (markupPct) {
                  itemDetail += ` (${markupPct}% markup)`;
                }
              }
              // Check if this is a shipping item
              if (itemName.toLowerCase().includes('shipping') || itemName.toLowerCase().includes('freight')) {
                itemDetail = 'Shipping charge';
              }
              break;
              
            case 'DiscountLineDetail':
              itemName = 'Discount';
              const pct = line.DiscountLineDetail?.DiscountPercent;
              itemDetail = pct ? `${pct}% discount` : 'Applied discount';
              amount = -Math.abs(amount);
              break;
              
            case 'SubTotalLineDetail':
              itemName = 'Subtotal';
              break;
              
            case 'TaxLineDetail':
              itemName = 'Tax';
              itemDetail = line.TaxLineDetail?.TaxRateRef?.name || '';
              break;
              
            case 'GroupLineDetail':
              itemName = line.GroupLineDetail?.GroupItemRef?.name || 'Group';
              itemDetail = 'Group';
              // Render the group header
              detailHtml += `
                <div class="line-item-row" style="background: #f9f9f9;">
                  <div class="line-item-desc">
                    <div class="line-item-name" style="font-weight: 600;">${itemName}</div>
                    <div class="line-item-qty">${itemDetail}</div>
                  </div>
                  <div class="line-item-amount"></div>
                </div>
              `;
              // Render child entries
              if (line.GroupLineDetail?.Line) {
                line.GroupLineDetail.Line.forEach(childLine => {
                  let childName = childLine.SalesItemLineDetail?.ItemRef?.name || childLine.Description || 'Item';
                  const childSku = childLine.SalesItemLineDetail?.Sku || '';
                  if (childSku) {
                    childName += ` <span style="color: #8c8c8c; font-size: 12px;">(SKU: ${childSku})</span>`;
                  }
                  const childQty = childLine.SalesItemLineDetail?.Qty || 1;
                  const childPrice = childLine.SalesItemLineDetail?.UnitPrice || childLine.Amount || 0;
                  const childAmount = childLine.Amount || 0;
                  detailHtml += `
                    <div class="line-item-row" style="padding-left: 16px;">
                      <div class="line-item-desc">
                        <div class="line-item-name">${childName}</div>
                        <div class="line-item-qty">${childQty} x ${formatCurrency(childPrice)}</div>
                      </div>
                      <div class="line-item-amount">${formatCurrency(childAmount)}</div>
                    </div>
                  `;
                });
              }
              showLine = false;
              break;
              
            case 'DescriptionOnly':
              itemName = line.Description || 'Note';
              amount = 0;
              break;
              
            case 'ItemBasedExpenseLineDetail':
              itemName = line.ItemBasedExpenseLineDetail?.ItemRef?.name || 'Expense';
              const expQty = line.ItemBasedExpenseLineDetail?.Qty || 1;
              const expPrice = line.ItemBasedExpenseLineDetail?.UnitPrice || line.Amount;
              itemDetail = `${expQty} x ${formatCurrency(expPrice)}`;
              break;
              
            default:
              if (line.Description) {
                itemName = line.Description;
              } else {
                showLine = false;
              }
          }
          
          if (!showLine) return;
          
          detailHtml += `
            <div class="line-item-row">
              <div class="line-item-desc">
                <div class="line-item-name">${itemName}</div>
                ${itemDetail ? `<div class="line-item-qty">${itemDetail}</div>` : ''}
              </div>
              <div class="line-item-amount">${formatCurrency(amount)}</div>
            </div>
          `;
        });
        
        detailHtml += '</div>';
      }
      
      // Add shipment section
      detailHtml += renderShipmentSection(invoice);
      
      document.getElementById('detailBody').innerHTML = detailHtml;
      document.getElementById('detailOverlay').classList.add('active');
      document.getElementById('detailPanel').classList.add('active');
    }
    
    function renderShipmentSection(invoice) {
      // Use fallback chain to find invoice number - QuickBooks may return it in different fields
      const docNumber = invoice.DocNumber || invoice.docNumber || invoice.Id || invoice.id;
      const shipmentInfo = shipmentData[docNumber];
      
      // Handle both old array format and new object format
      const shipments = Array.isArray(shipmentInfo) ? shipmentInfo : (shipmentInfo?.shipments || []);
      const summary = shipmentInfo?.summary;
      
      // Debug logging
      console.log('[ShipStation Modal] renderShipmentSection - docNumber:', docNumber, '(from DocNumber:', invoice.DocNumber, ', Id:', invoice.Id, ')');
      console.log('[ShipStation Modal] renderShipmentSection - shipmentData keys:', Object.keys(shipmentData));
      console.log('[ShipStation Modal] renderShipmentSection - shipments for this invoice:', shipments);
      console.log('[ShipStation Modal] renderShipmentSection - summary:', summary);
      console.log('[ShipStation Modal] renderShipmentSection - shipstationConnected:', shipstationConnected);
      
      let html = '<div class="shipment-section">';
      html += '<div class="shipment-section-title">üì¶ Shipment Details</div>';
      
      if (!shipstationConnected) {
        html += `
          <div class="ss-connect-hint">
            ShipStation is not connected. Connect ShipStation in your app settings to track shipments.
          </div>
        `;
        html += '</div>';
        return html;
      }
      
      if (!shipments || shipments.length === 0) {
        const balance = parseFloat(invoice.Balance || 0);
        const salesTermRef = invoice.SalesTermRef?.name || '';
        
        if (balance > 0 && salesTermRef.toLowerCase().includes('receipt')) {
          html += `
            <div class="shipment-card">
              <div class="shipment-header">
                <span class="shipment-badge shipment-pending-payment">‚è≥ Pending Payment</span>
              </div>
              <div class="shipment-items">
                Shipment will be created automatically once payment is received.
              </div>
            </div>
          `;
        } else {
          html += `
            <div class="shipment-card">
              <div class="shipment-header">
                <span class="shipment-badge shipment-none">No ShipStation Order</span>
              </div>
              <div class="shipment-items">
                No order has been created in ShipStation for this invoice.
              </div>
            </div>
          `;
        }
        html += '</div>';
        return html;
      }
      
      // Show fulfillment summary if available
      if (summary && summary.totalOrderItems > 0) {
        const statusClass = summary.isFullyShipped ? 'shipment-delivered' : 
                           summary.isPartiallyShipped ? 'shipment-transit' : 'shipment-awaiting';
        const statusText = summary.isFullyShipped ? 'Fully Shipped' :
                          summary.isPartiallyShipped ? 'Partially Shipped' : 'Awaiting Shipment';
        
        html += `
          <div class="fulfillment-summary" style="background: #f0f5ff; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="font-weight: 600; color: #1a1a1a;">Fulfillment Status</span>
                <span class="shipment-badge ${statusClass}" style="margin-left: 8px;">${statusText}</span>
              </div>
              <div style="text-align: right;">
                <span style="font-size: 18px; font-weight: 600; color: #1890ff;">${summary.totalShippedItems}</span>
                <span style="color: #8c8c8c;"> / ${summary.totalOrderItems} items shipped</span>
              </div>
            </div>
            ${summary.shipmentCount > 1 ? `<div style="font-size: 12px; color: #595959; margin-top: 4px;">${summary.shipmentCount} shipments for this order</div>` : ''}
          </div>
        `;
      }
      
      // Render each shipment
      shipments.forEach((shipment, index) => {
        const shipmentLabel = shipments.length > 1 ? ` - Shipment ${index + 1}` : '';
        const statusClass = getShipmentBadgeClass(shipment.shipmentStatus);
        
        html += '<div class="shipment-card">';
        
        // Order number at the top (with shipment number for multiple shipments)
        if (shipment.orderNumber || shipment.orderId || shipmentLabel) {
          html += '<div class="shipment-order-number">';
          if (shipmentLabel) {
            html += `<strong style="color: #1890ff;">Shipment ${index + 1}</strong>`;
            if (shipment.orderNumber) {
              html += ` <span style="color: #8c8c8c;">‚Ä¢ Order: ${shipment.orderNumber}</span>`;
            }
          } else {
            html += `<strong>Order:</strong> ${shipment.orderNumber || ''}`;
            if (shipment.orderId) {
              html += ` <span style="color: #8c8c8c;">(ID: ${shipment.orderId})</span>`;
            }
          }
          html += '</div>';
        }
        
        // Status header
        html += '<div class="shipment-header">';
        html += `<span class="shipment-badge ${statusClass}">${shipment.shipmentStatus}</span>`;
        html += '</div>';
        
        // Details grid
        html += '<div class="shipment-details-grid">';
        
        // Ship Date
        if (shipment.shipDate) {
          html += '<div class="shipment-detail-item">';
          html += '<span class="shipment-detail-label">Ship Date</span>';
          html += `<span class="shipment-detail-value">${formatDate(shipment.shipDate)}</span>`;
          html += '</div>';
        }
        
        // Delivery Date (if delivered)
        if (shipment.deliveryDate) {
          html += '<div class="shipment-detail-item">';
          html += '<span class="shipment-detail-label">Delivered</span>';
          html += `<span class="shipment-detail-value">${formatDate(shipment.deliveryDate)}</span>`;
          html += '</div>';
        }
        
        // Carrier
        if (shipment.carrierCode) {
          html += '<div class="shipment-detail-item">';
          html += '<span class="shipment-detail-label">Carrier</span>';
          html += `<span class="shipment-detail-value">${formatCarrierName(shipment.carrierCode)}</span>`;
          html += '</div>';
        }
        
        // Service
        if (shipment.serviceCode) {
          html += '<div class="shipment-detail-item">';
          html += '<span class="shipment-detail-label">Service</span>';
          html += `<span class="shipment-detail-value">${formatServiceName(shipment.serviceCode)}</span>`;
          html += '</div>';
        }
        
        // Order Status (when no shipment yet)
        if (shipment.orderStatus && !shipment.trackingNumber) {
          html += '<div class="shipment-detail-item">';
          html += '<span class="shipment-detail-label">Order Status</span>';
          html += `<span class="shipment-detail-value">${formatOrderStatus(shipment.orderStatus)}</span>`;
          html += '</div>';
        }
        
        // Create Date (when order exists but not shipped)
        if (shipment.createDate && !shipment.shipDate) {
          html += '<div class="shipment-detail-item">';
          html += '<span class="shipment-detail-label">Order Created</span>';
          html += `<span class="shipment-detail-value">${formatDate(shipment.createDate)}</span>`;
          html += '</div>';
        }
        
        html += '</div>'; // end details grid
        
        // Tracking section (prominent)
        if (shipment.trackingNumber) {
          const trackingUrl = getTrackingUrl(shipment.carrierCode, shipment.trackingNumber);
          html += '<div class="shipment-tracking-section">';
          html += '<span class="shipment-tracking-label">TRACKING NUMBER</span>';
          html += `<a href="${trackingUrl}" target="_blank" class="shipment-tracking-number">${shipment.trackingNumber} ‚Üó</a>`;
          html += '</div>';
        }
        
        // Ship-to address (if available)
        if (shipment.shipTo && (shipment.shipTo.city || shipment.shipTo.state)) {
          html += '<div style="font-size: 11px; color: #8c8c8c; margin-top: 8px;">';
          html += '<strong>Ship To:</strong> ';
          const addressParts = [
            shipment.shipTo.name,
            shipment.shipTo.city,
            shipment.shipTo.state,
            shipment.shipTo.postalCode
          ].filter(Boolean);
          html += addressParts.join(', ');
          html += '</div>';
        }
        
        // Items section
        if (shipment.items && shipment.items.length > 0) {
          html += '<div class="shipment-items-section">';
          html += '<div class="shipment-items-title">ITEMS IN SHIPMENT</div>';
          shipment.items.forEach(item => {
            const sku = item.sku ? ` (${item.sku})` : '';
            html += `<div class="shipment-item-row">${item.quantity || 1}x ${item.name || 'Item'}${sku}</div>`;
          });
          html += '</div>';
        }
        
        html += '</div>';
      });
      
      html += '</div>';
      return html;
    }
    
    function getShipmentBadgeClass(status) {
      if (!status) return 'shipment-none';
      const s = status.toLowerCase();
      if (s.includes('delivered')) return 'shipment-delivered';
      if (s.includes('transit')) return 'shipment-transit';
      if (s.includes('awaiting') || s.includes('pending')) return 'shipment-awaiting';
      return 'shipment-awaiting';
    }
    
    function getTrackingUrl(carrier, trackingNumber) {
      if (!carrier || !trackingNumber) return '#';
      
      const c = carrier.toLowerCase();
      if (c.includes('ups')) {
        return `https://www.ups.com/track?tracknum=${trackingNumber}`;
      }
      if (c.includes('fedex')) {
        return `https://www.fedex.com/fedextrack/?trknbr=${trackingNumber}`;
      }
      if (c.includes('usps')) {
        return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${trackingNumber}`;
      }
      if (c.includes('dhl')) {
        return `https://www.dhl.com/en/express/tracking.html?AWB=${trackingNumber}`;
      }
      return `https://www.google.com/search?q=${trackingNumber}+tracking`;
    }
    
    function formatCarrierName(carrierCode) {
      if (!carrierCode) return '-';
      const carriers = {
        'ups': 'UPS',
        'fedex': 'FedEx',
        'usps': 'USPS',
        'dhl_express': 'DHL Express',
        'dhl_ecommerce': 'DHL eCommerce',
        'stamps_com': 'Stamps.com',
        'endicia': 'Endicia',
        'ups_mi': 'UPS Mail Innovations',
        'amazon_buy_shipping': 'Amazon',
        'ontrac': 'OnTrac',
        'globegistics': 'Globegistics',
        'asendia': 'Asendia',
        'purolator': 'Purolator',
        'canada_post': 'Canada Post',
        'royal_mail': 'Royal Mail',
        'australia_post': 'Australia Post'
      };
      return carriers[carrierCode.toLowerCase()] || carrierCode.toUpperCase();
    }
    
    function formatServiceName(serviceCode) {
      if (!serviceCode) return '-';
      return serviceCode
        .replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
    }
    
    function formatOrderStatus(orderStatus) {
      if (!orderStatus) return '-';
      const statuses = {
        'awaiting_payment': 'Awaiting Payment',
        'awaiting_shipment': 'Awaiting Shipment',
        'pending_fulfillment': 'Pending Fulfillment',
        'shipped': 'Shipped',
        'on_hold': 'On Hold',
        'cancelled': 'Cancelled'
      };
      return statuses[orderStatus.toLowerCase()] || orderStatus.replace(/_/g, ' ');
    }
    
    function closeDetail() {
      document.getElementById('detailOverlay').classList.remove('active');
      document.getElementById('detailPanel').classList.remove('active');
    }
    
    async function downloadInvoicePdf(invoiceId, invoiceNum) {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '...';
      
      try {
        const response = await fetch(`/api/invoices/${invoiceId}/pdf?userId=${encodeURIComponent(userId)}`);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to download PDF');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `invoice-${invoiceNum}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
      } catch (error) {
        console.error('Error downloading PDF:', error);
        alert('Failed to download PDF: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }
    
    async function copyPaymentLink(invoiceId, invoiceNum, btn) {
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '...';
      
      try {
        const response = await fetch(`/api/invoices/${invoiceId}/paylink?userId=${encodeURIComponent(userId)}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to get payment link');
        }
        
        if (!data.paymentLink) {
          throw new Error('No payment link available');
        }
        
        await navigator.clipboard.writeText(data.paymentLink);
        
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
          btn.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('Error copying payment link:', error);
        alert('Failed to get payment link: ' + error.message);
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }
    
    function showError(message) {
      document.getElementById('invoiceContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <div class="empty-state-text">Error</div>
          <div class="empty-state-subtext">${message}</div>
        </div>
      `;
    }
    
    function closeModal() {
      if (sdk) {
        sdk.execute(AppExtensionsSDK.Command.CLOSE_MODAL);
      } else {
        window.close();
      }
    }
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
